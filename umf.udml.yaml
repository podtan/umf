# UDML Specification for Universal Message Format (UMF)
# This file defines the UDML structure for UMF v0.2.0 with UDML/URP support

$schema: "https://udml.podtan.com/schema/v0.1"
version: "0.1"
id: umf
layer: runtime
ownership: crate
summary: "Universal Message Format - Provider-agnostic message representation for LLM interactions with ChatML formatting support"
purpose: "Provides standardized message structures and transformations for LLM communication across different providers"
version_number: "0.2.0"
author: "Simpaticoder Contributors"
tags:
  - llm
  - message-format
  - openai
  - anthropic
  - provider-agnostic
  - chatml
  - streaming

repository: "https://github.com/podtan/umf"
homepage: "https://umf.podtan.com"

dependencies:
  compile_time:
    - serde
    - serde_json
    - tiktoken-rs
    - futures-util
  runtime:
    - none

provides:
  # ============================================================================
  # INFORMATION DOMAIN - Message Data Structures
  # ============================================================================
  information:
    purpose: "Defines all message data structures and content types for LLM interactions"
    entities:
      - id: internal-message
        kind: struct
        purpose: "Core message representation with role, content, and metadata"
        owners: [umf]
        fields:
          - role
          - content
          - metadata
          - tool_call_id
          - name
        schema_ref: "umf#internal-message"
        version: "1.0.0"
        mutable: true
        persistent: false
        
      - id: message-role
        kind: enum
        purpose: "Message role in conversation (system, user, assistant, tool)"
        owners: [umf]
        fields:
          - system
          - user
          - assistant
          - tool
        schema_ref: "umf#message-role"
        version: "1.0.0"
        mutable: false
        persistent: false
        
      - id: message-content
        kind: enum
        purpose: "Message content representation (text or structured blocks)"
        owners: [umf]
        fields:
          - text
          - blocks
        schema_ref: "umf#message-content"
        version: "1.0.0"
        mutable: true
        persistent: false
        
      - id: content-block
        kind: enum
        purpose: "Structured content block for multimodal messages (text, image, tool-use, tool-result)"
        owners: [umf]
        fields:
          - text
          - image
          - tool-use
          - tool-result
        schema_ref: "umf#content-block"
        version: "1.0.0"
        mutable: false
        persistent: false
        
      - id: tool-call
        kind: struct
        purpose: "Represents a tool/function call from LLM"
        owners: [umf]
        fields:
          - id
          - type
          - function
        schema_ref: "umf#tool-call"
        version: "1.0.0"
        mutable: false
        persistent: false
        
      - id: function-call
        kind: struct
        purpose: "Function call details with name and arguments"
        owners: [umf]
        fields:
          - name
          - arguments
        schema_ref: "umf#function-call"
        version: "1.0.0"
        mutable: false
        persistent: false
        
      - id: chatml-message
        kind: struct
        purpose: "ChatML formatted message for provider communication"
        owners: [umf]
        fields:
          - role
          - content
          - name
          - tool_call_id
          - tool_calls
        schema_ref: "umf#chatml-message"
        version: "1.0.0"
        mutable: false
        persistent: false
        
      - id: stream-chunk
        kind: struct
        purpose: "Individual chunk from streaming LLM response"
        owners: [umf]
        fields:
          - delta
          - finish_reason
          - usage
        schema_ref: "umf#stream-chunk"
        version: "1.0.0"
        mutable: false
        persistent: false
        
      - id: accumulated-response
        kind: struct
        purpose: "Complete accumulated streaming response"
        owners: [umf]
        fields:
          - content
          - tool_calls
          - finish_reason
          - usage
        schema_ref: "umf#accumulated-response"
        version: "1.0.0"
        mutable: true
        persistent: false

  # ============================================================================
  # ACCESS DOMAIN - Message Access Rules
  # ============================================================================
  access:
    rules:
      - id: message-read
        target: "internal-message"
        read: "any"
        visibility: internal
        description: "Allow reading message content and metadata for all message types"
        constraints:
          - message-exists
        
      - id: message-create
        target: "internal-message"
        read: "any"
        write: "any"
        visibility: internal
        description: "Allow creating new messages with role and content"
        constraints:
          - role-is-valid-enum
          - content-not-empty-for-text
          - tool-messages-have-call-id
        
      - id: stream-subscribe
        target: "stream-chunk"
        read: "any"
        visibility: internal
        description: "Allow subscribing to streaming message responses"
        constraints:
          - valid-stream-connection
        
      - id: format-convert
        target: "internal-message"
        read: "any"
        write: "any"
        visibility: internal
        description: "Allow converting between internal and provider formats"
        constraints:
          - format-compatibility

  # ============================================================================
  # MANIPULATION DOMAIN - Message Mutation Operations
  # ============================================================================
  manipulation:
    mutations:
      - id: create-system-message
        target: "internal-message"
        kind: create
        operation: "InternalMessage::system(text: String) -> InternalMessage"
        description: "Create a new system message with the given text content"
        preconditions:
          - text-not-empty
        postconditions:
          - role-is-system
        validation:
          - text-is-string
        
      - id: create-user-message
        target: "internal-message"
        kind: create
        operation: "InternalMessage::user(text: String) -> InternalMessage"
        description: "Create a new user message with the given text content"
        
      - id: create-assistant-message
        target: "internal-message"
        kind: create
        operation: "InternalMessage::assistant(text: String) -> InternalMessage"
        description: "Create a new assistant message with the given text content"
        
      - id: create-assistant-with-tools
        target: "internal-message"
        kind: create
        operation: "InternalMessage::assistant_with_tools(text: String, tools: Vec<ContentBlock>) -> InternalMessage"
        description: "Create assistant message with tool calls"
        
      - id: create-tool-result-message
        target: "internal-message"
        kind: create
        operation: "InternalMessage::tool_result(tool_call_id: String, name: String, content: ContentBlock) -> InternalMessage"
        description: "Create tool result message"
        
      - id: add-metadata
        target: "internal-message"
        kind: update
        operation: "add_metadata(message: &mut InternalMessage, key: String, value: String)"
        description: "Add metadata key-value pair to message"
        
      - id: accumulate-stream-chunk
        target: "accumulated-response"
        kind: update
        operation: "StreamingAccumulator::accumulate_chunk(chunk: StreamChunk)"
        description: "Accumulate streaming chunk into response"

  # ============================================================================
  # EXTRACT DOMAIN - Message Transformations
  # ============================================================================
  extract:
    transforms:
      - id: to-chatml
        inputs: ["internal-message"]
        output: "chatml-message"
        method: template
        deterministic: true
        cacheable: false
        description: "Transform InternalMessage to ChatML format by mapping role and flattening content"
        
      - id: from-chatml
        inputs: ["chatml-message"]
        output: "internal-message"
        method: template
        deterministic: true
        cacheable: false
        description: "Transform ChatML message to InternalMessage by parsing content structure"
        
      - id: extract-text-content
        inputs: ["internal-message"]
        output: "string"
        method: projection
        deterministic: true
        cacheable: true
        description: "Extract plain text from message content blocks"
        
      - id: count-tokens
        inputs: ["chatml-message"]
        output: "token-count"
        method: algorithm
        deterministic: true
        cacheable: true
        description: "Count tokens in message using tiktoken cl100k_base"
        
      - id: parse-sse-chunk
        inputs: ["raw-sse-line"]
        output: "stream-chunk"
        method: algorithm
        deterministic: true
        cacheable: false
        description: "Parse SSE (Server-Sent Events) streaming chunk from provider"
        
      - id: accumulate-streaming-response
        inputs: ["stream-chunk"]
        output: "accumulated-response"
        method: aggregation
        deterministic: true
        cacheable: false
        description: "Accumulate streaming chunks into complete response"

  # ============================================================================
  # MOVEMENT DOMAIN - Message Routing and Streaming
  # ============================================================================
  movement:
    routes:
      - id: to-provider
        direction: out
        from: "umf"
        to: "llm-provider"
        medium: network
        payload: "chatml-message"
        protocol: "https-json"
        trigger: request
        reliability: at-least-once
        async: true
        description: "Send formatted messages to LLM provider API"
        
      - id: from-provider-stream
        direction: in
        from: "llm-provider"
        to: "umf"
        medium: network
        payload: "stream-chunk"
        protocol: "sse"
        trigger: event
        reliability: at-least-once
        async: true
        description: "Receive streaming response chunks from LLM provider"
        
      - id: internal-message-passing
        direction: bi
        from: "umf"
        to: "any"
        medium: memory
        payload: "internal-message"
        trigger: request
        reliability: exactly-once
        async: false
        description: "Pass messages between components in memory"

  # ============================================================================
  # COORDINATION DOMAIN - Message Processing Orchestration
  # ============================================================================
  coordination:
    primitives:
      - id: format-conversion-pipeline
        kind: orchestration
        participants: ["umf", "chatml-formatter"]
        drives: ["to-provider"]
        description: "Coordinate transformation from internal format to provider format"
        guarantees:
          - format-compatibility
          - validation-before-send
        
      - id: streaming-accumulation
        kind: orchestration
        participants: ["stream-receiver", "accumulator"]
        drives: ["from-provider-stream"]
        description: "Coordinate accumulation of streaming chunks into complete response"
        guarantees:
          - ordered-accumulation
          - complete-response
        failure_modes:
          - connection-lost
          - incomplete-stream

# ============================================================================
# INTEGRATION PATTERNS
# ============================================================================
